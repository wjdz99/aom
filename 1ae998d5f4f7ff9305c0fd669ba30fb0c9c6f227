{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "732a4160_f72b5d19",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 15030
      },
      "writtenOn": "2021-08-17T07:22:58Z",
      "side": 1,
      "message": "Hi Yunqing, \nIn this CL, we have allocated TPL buffers (stats buffers and frame buffers) based on lag_in_frames. \nThis CL is verified to be bit-exact with no impact on encode-time. We have tested this for various values of lag_in_frames. Memory is measured using the command valgrind --tool\u003dmassif ./aomenc ...\n\nThe memory reduction results for speed 6 are as follows\n                        Memory Reduction(%)\n                        Single      Multi\nResolution    Tile      thread      thread\n640x360       2x1       8.54        8.03(2 threads)\n832x480       2x1       9.68        9.26(2 threads)\n1280x720      2x2       10.78       10.07(4 threads)\n1920x1080     4x2       11.59       10.71(8 threads)\n\nThe memory savings are similar for other speed levels as well .\n",
      "revId": "1ae998d5f4f7ff9305c0fd669ba30fb0c9c6f227",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "16b04675_46ce3a59",
        "filename": "av1/encoder/tpl_model.c",
        "patchSetId": 3
      },
      "lineNbr": 160,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-08-17T16:52:38Z",
      "side": 1,
      "message": "Here the allocation is changed. But MAX_LAG_BUFFERS is still used when these buffers are freed. Would that cause problems?",
      "range": {
        "startLine": 160,
        "startChar": 30,
        "endLine": 160,
        "endChar": 43
      },
      "revId": "1ae998d5f4f7ff9305c0fd669ba30fb0c9c6f227",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6fd03aa3_bc0f4741",
        "filename": "av1/encoder/tpl_model.c",
        "patchSetId": 3
      },
      "lineNbr": 160,
      "author": {
        "id": 15030
      },
      "writtenOn": "2021-08-18T07:24:47Z",
      "side": 1,
      "message": "Yunqing,\n\nThe function aom_free, which is used to free buffers has a NULL check. As the structure TplParams, that holds all the TPL buffer pointers, is initialized to zero during init, this change should not cause any issue during free. Also, we see that  deallocation typically happens for the maximum value in libaom.  For example, allocation of loop restoration structure buffers in the function av1_alloc_restoration_buffers happens for \"num_planes\" and the deallocation of the same happens in the function av1_free_restoration_buffers for MAX_MB_PLANE.  \n\nHope this clarifies your query. Please let us know your opinion on the above.",
      "parentUuid": "16b04675_46ce3a59",
      "range": {
        "startLine": 160,
        "startChar": 30,
        "endLine": 160,
        "endChar": 43
      },
      "revId": "1ae998d5f4f7ff9305c0fd669ba30fb0c9c6f227",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0177c5a9_c560306a",
        "filename": "av1/encoder/tpl_model.c",
        "patchSetId": 3
      },
      "lineNbr": 160,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-08-18T15:22:46Z",
      "side": 1,
      "message": "Sounds good. Thanks for checking it!",
      "parentUuid": "6fd03aa3_bc0f4741",
      "range": {
        "startLine": 160,
        "startChar": 30,
        "endLine": 160,
        "endChar": 43
      },
      "revId": "1ae998d5f4f7ff9305c0fd669ba30fb0c9c6f227",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}
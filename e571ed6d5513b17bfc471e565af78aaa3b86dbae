{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "542a179a_67026d99",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 13265
      },
      "writtenOn": "2021-08-18T18:48:16Z",
      "side": 1,
      "message": "Hi Yunqing,\n\nThis patch makes the functions that allocate memory for loop filter, CDEF and loop restoration modules non-static to aid the follow-up CL that subsumes all multi-threaded modules related initializations under the FPMT framework.\n\nAlso, the interface of alloc_cdef_buffers() is modified to include a flag to indicate whether cdef_worker (AV1CdefWorkerData) allocation is to be done or not. This is to ensure that in the subsequent CL, when alloc_cdef_buffers() is called for a parallel frame, cdef_worker should not be reallocated for the fewer no. of threads. As an example, if we have total 8 threads and 2 parallel frames, then level 0 frames will be processed by all 8 workers while level 1 and level 2 frames will be processed by 4 workers each. In alloc_cdef_buffers(), cdef_worker is reallocated for a frame whenever there is a change in the no. of workers, which should not happen for parallel frame encode. The newly introduced flag init_worker helps to decouple the initialization of cdef_worker from the rest of the initializations inside the function, thereby ensuring that unwanted re-initialization of cdef_worker would not occur for a parallel frame (more details are present in the dependent CL).\n\nPlease review the patch.\n\nThanks,\nNithya",
      "revId": "e571ed6d5513b17bfc471e565af78aaa3b86dbae",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c9b77387_850e7abb",
        "filename": "av1/common/alloccommon.c",
        "patchSetId": 3
      },
      "lineNbr": 230,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-08-18T20:34:18Z",
      "side": 1,
      "message": "Not sure that I understand why init_worker is necessary? Can we realloc the buffer if (cdef_info-\u003eallocated_num_workers \u003c num_workers)?",
      "range": {
        "startLine": 230,
        "startChar": 30,
        "endLine": 230,
        "endChar": 41
      },
      "revId": "e571ed6d5513b17bfc471e565af78aaa3b86dbae",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "420d48cb_9342b2f6",
        "filename": "av1/common/alloccommon.c",
        "patchSetId": 3
      },
      "lineNbr": 230,
      "author": {
        "id": 13265
      },
      "writtenOn": "2021-08-19T02:43:31Z",
      "side": 1,
      "message": "The flag init_worker is introduced to ensure that decoder behaviour is not affected. Now reallocation happens if cdef_info-\u003eallocated_num_workers !\u003d num_workers and init_worker \u003d 1 (when called from decoder, init_worker is always passed as 1). In the encoder side, we need to control the reallocation based on whether the frame is a parallel frame or not. For parallel frames, reallocation of cdef_worker need not happen. The follow-up CL contains the change where there are separate calls for parallel frames where init_worker is made 0, so that only cm buffers and cdef_sync are initialized.",
      "parentUuid": "c9b77387_850e7abb",
      "range": {
        "startLine": 230,
        "startChar": 30,
        "endLine": 230,
        "endChar": 41
      },
      "revId": "e571ed6d5513b17bfc471e565af78aaa3b86dbae",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}